#!/bin/sh
set -e
#  подчищаем
trap 'rm -rf -- tmp temp.xml domain.xml ucpackage.xml ToC.xml' EXIT
TMP="tmp";
DOMAIN_TO_DOCS="bin/resources/stylesheets/docs/domain2docs.xsl";
UCPACKAGE_TO_DOCS="bin/resources/stylesheets/docs/ucpackage2docs.xsl";
DOMAIN_TO_DOT="bin/resources/stylesheets/docs/domain2dot.xsl";
UCPACKAGE_TO_DOT="bin/resources/stylesheets/docs/ucpackage2dot.xsl";

cd ../../
DOMAIN_NS=`pwd | awk -F "/" '{print $NF}'`
cd docs/

# создадим директорию в которую будем сохранять промежуточные результаты сборки
mkdir -p $TMP
# все глоссарии проекта
echo "..... build domain"
echo "<?xml version='1.0' encoding='utf-8'?>\n<d:domains ID='${DOMAIN_NS}' xlink:title='Модель предметной области' xmlns:d='urn:docs:domain' xmlns:xlink='http://www.w3.org/1999/xlink'>" > temp.xml
#find domain -type f | while read j; do
for j in domain/*.xml; do
	echo "<d:domain xlink:type='locator' xlink:href='${j}' />" >> temp.xml
done
echo "</d:domains>" >> temp.xml

# собираем все термины предметных областей проекта
echo "..... build domain instance file"
xsltproc --stringparam NS "$DOMAIN_NS" "$DOMAIN_TO_DOCS" temp.xml > domain.xml
chmod 777 domain.xml

#  строим диаграммы доменной области
echo "..... prepare domain svg files"
find domain -type f | while read j; do
	pack="${j%.xml}"
	pack="${pack#domain/}"
	ns="${pack//[\/]/:}"
	#echo "${ns}"
	mkdir -p $TMP/graphviz/$pack/
	chmod 777 $TMP/graphviz/$pack
	mkdir -p $TMP/images/$pack/
	chmod 777 $TMP/images/$pack
	xsltproc --stringparam NS "$ns" ${DOMAIN_TO_DOT} domain.xml > $TMP/graphviz/$pack/domain.dot
	dot -Tsvg -o${TMP}/images/$pack/domain.svg $TMP/graphviz/$pack/domain.dot
	chmod 777 $TMP/images/$pack/domain.svg
	#sed 's/Times,serif/Tahoma,Verdana/g' $TMP/images/$pack/domain.svg > $TMP/images/$pack/domain_.svg
	#mv $TMP/images/$pack/domain_.svg $TMP/images/$pack/domain.svg
done

# все пакеты сценариев проекта
echo "..... build usecases"
echo "<?xml version='1.0' encoding='utf-8'?><ucpackage ID='${DOMAIN_NS}' xlink:title='Прецеденты использования' xmlns:d='urn:docs:domain' xmlns='urn:docs:ucpackage' xmlns:xlink='http://www.w3.org/1999/xlink'>" > temp.xml
#find ucpackage -type f | while read j; do
find ucpackage -type f -maxdepth 1 | while read j; do
#for j in ucpackage/*.xml; do
	echo "<ucpackage xlink:type='locator' xlink:href='${j}' />" >> temp.xml
done
echo "</ucpackage>" >> temp.xml

# собираем вcе прецеденты проекта
echo "..... build usecases instance file"
xsltproc --stringparam NS "$DOMAIN_NS" "$UCPACKAGE_TO_DOCS" temp.xml > ucpackage.xml
chmod 777 ucpackage.xml

# строим все диаграммы прецедентов
echo "..... prepare usecase svg file"
find ucpackage -type f | while read j; do
	pack="${j%.xml}"
	pack="${pack#ucpackage/}"
	ns="${pack//[\/]/:}"
	#echo "${pack}"

	mkdir -p $TMP/graphviz/$pack/
	#chmod 777 $TMP/graphviz/$pack
	mkdir -p $TMP/images/$pack/
	#chmod 777 $TMP/images/$pack
	xsltproc --stringparam NS "$ns" ${UCPACKAGE_TO_DOT} ucpackage.xml > $TMP/graphviz/$pack/ucpackage.dot
	dot -Tsvg -o${TMP}/images/$pack/ucpackage.svg $TMP/graphviz/$pack/ucpackage.dot
	#chmod 777 $TMP/images/$pack/ucpackage.svg
done

# собираем всю документацию проекта в TOC
echo "..... build table of contents"
xsltproc bin/resources/stylesheets/docs/docs2toc.xsl temp.xml > TOC.xml

# делаем готовый файл документации для удобства просмотра
echo "..... prepare domain docs html"
xsltproc --novalid bin/resources/web/stylesheets/domain.xsl domain.xml > domain.html
chmod 777 domain.html
echo "..... prepare usecases docs html"
xsltproc --novalid bin/resources/web/stylesheets/ucpackage.xsl ucpackage.xml > ucpackage.html

chmod 777 ucpackage.html

exit;
